from fastapi import APIRouter, Depends, HTTPException, status, Query\nfrom sqlmodel import Session, select\nfrom typing import List, Optional\nfrom ..models import Task, TaskCreate, TaskRead, TaskUpdate\nfrom ..dependencies import get_current_user\nfrom ..db import get_session\nfrom uuid import UUID\nfrom datetime import datetime\n\nrouter = APIRouter()\n\n@router.get("/tasks", response_model=List[TaskRead])\nasync def get_tasks(\n    current_user: dict = Depends(get_current_user),\n    session: Session = Depends(get_session),\n    status: Optional[str] = Query(None, description="Filter by status: all, pending, completed"),\n    sort: Optional[str] = Query(None, description="Sort by: created_at, updated_at, title")\n):\n    """Get all tasks for the current user"""\n    user_id = current_user["user_id"]\n    \n    query = select(Task).where(Task.user_id == user_id)\n    \n    if status:\n        if status == "pending":\n            query = query.where(Task.completed == False)\n        elif status == "completed":\n            query = query.where(Task.completed == True)\n    \n    if sort:\n        if sort == "created_at":\n            query = query.order_by(Task.created_at)\n        elif sort == "updated_at":\n            query = query.order_by(Task.updated_at)\n        elif sort == "title":\n            query = query.order_by(Task.title)\n    \n    tasks = session.exec(query).all()\n    return tasks\n\n@router.post("/tasks", response_model=TaskRead, status_code=status.HTTP_201_CREATED)\nasync def create_task(\n    task_data: TaskCreate,\n    current_user: dict = Depends(get_current_user),\n    session: Session = Depends(get_session)\n):\n    """Create a new task for the current user"""\n    user_id = current_user["user_id"]\n    \n    task = Task(\n        title=task_data.title,\n        description=task_data.description,\n        completed=task_data.completed,\n        user_id=user_id\n    )\n    \n    session.add(task)\n    session.commit()\n    session.refresh(task)\n    \n    return task\n\n@router.get("/tasks/{task_id}", response_model=TaskRead)\nasync def get_task(\n    task_id: UUID,\n    current_user: dict = Depends(get_current_user),\n    session: Session = Depends(get_session)\n):\n    """Get a specific task by ID"""\n    user_id = current_user["user_id"]\n    \n    task = session.get(Task, task_id)\n    if not task:\n        raise HTTPException(status_code=404, detail="Task not found")\n    \n    if task.user_id != user_id:\n        raise HTTPException(status_code=403, detail="Not authorized to access this task")\n    \n    return task\n\n@router.put("/tasks/{task_id}", response_model=TaskRead)\nasync def update_task(\n    task_id: UUID,\n    task_update: TaskUpdate,\n    current_user: dict = Depends(get_current_user),\n    session: Session = Depends(get_session)\n):\n    """Update a specific task"""\n    user_id = current_user["user_id"]\n    \n    task = session.get(Task, task_id)\n    if not task:\n        raise HTTPException(status_code=404, detail="Task not found")\n    \n    if task.user_id != user_id:\n        raise HTTPException(status_code=403, detail="Not authorized to update this task")\n    \n    # Update task fields\n    update_data = task_update.model_dump(exclude_unset=True)\n    for field, value in update_data.items():\n        setattr(task, field, value)\n    \n    task.updated_at = datetime.utcnow()\n    session.add(task)\n    session.commit()\n    session.refresh(task)\n    \n    return task\n\n@router.delete("/tasks/{task_id}", status_code=status.HTTP_204_NO_CONTENT)\nasync def delete_task(\n    task_id: UUID,\n    current_user: dict = Depends(get_current_user),\n    session: Session = Depends(get_session)\n):\n    """Delete a specific task"""\n    user_id = current_user["user_id"]\n    \n    task = session.get(Task, task_id)\n    if not task:\n        raise HTTPException(status_code=404, detail="Task not found")\n    \n    if task.user_id != user_id:\n        raise HTTPException(status_code=403, detail="Not authorized to delete this task")\n    \n    session.delete(task)\n    session.commit()\n    \n    return {"detail": "Task deleted successfully"}\n\n@router.patch("/tasks/{task_id}/complete", response_model=TaskRead)\nasync def toggle_task_completion(\n    task_id: UUID,\n    current_user: dict = Depends(get_current_user),\n    session: Session = Depends(get_session)\n):\n    """Toggle the completion status of a task"""\n    user_id = current_user["user_id"]\n    \n    task = session.get(Task, task_id)\n    if not task:\n        raise HTTPException(status_code=404, detail="Task not found")\n    \n    if task.user_id != user_id:\n        raise HTTPException(status_code=403, detail="Not authorized to update this task")\n    \n    task.completed = not task.completed\n    task.updated_at = datetime.utcnow()\n    session.add(task)\n    session.commit()\n    session.refresh(task)\n    \n    return task
